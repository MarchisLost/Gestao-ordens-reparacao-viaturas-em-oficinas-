<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <title>Vista Responsavel</title>

        <!-- Bootstrap CSS CDN -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
        <!-- Our Custom CSS -->
        <link rel="stylesheet" href="../css/responsavel.css">

        <!-- Font Awesome JS -->
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>

    </head>

    <body>

        <div class="wrapper">
            <!-- Sidebar Holder -->
            <nav id="sidebar">
                <div class="sidebar-header">
                    <h3>Responsável</h3>
                </div>

                <ul class="list-unstyled components">
                    <p>{{user}}</p>
                    <li>
                        <a class="dropdown-toggle" data-toggle="modal" href="#exampleModal">Aceitar Orçamentos</a>
                        <a href="#">Atribuir Veiculos</a>
                        <a href="/dashboard">Dashboard</a>
                        <a href="/rececionista/{{user}}">Rececionista</a>
                        <a href="/workview/{{user}}">Mecanico</a>
                    </li>
                </ul>

                <ul class="list-unstyled CTAs">
                    <li>
                        <a href="/" class="download">Logout</a>
                    </li>
                </ul>
            </nav>

            <!-- Page Content Holder -->
            <div id="content">

                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">

                        <button type="button" id="sidebarCollapse" class="navbar-btn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-align-justify"></i>
                        </button>
                    </div>
                </nav>
                
                <h2>Lista Veículos à Espera</h2>
                <div class="container">
                    <div class="row">

                        <div class="col">
                            <div id="carrosEsperaColuna" class="card card-body">

                            </div>
                        </div>
                    </div>
                </div>

                <div class="line"></div>

                <h2>Lista Veículos em Reparação</h2>
                <div class="container">
                    <div class="row">

                        <div class="col">
                            <div id="carrosReparacaoColuna" class="card card-body">

                            </div>
                        </div>
                    </div>
                </div>

                <div class="line"></div>

                <h2>Lista Veículos Prontos</h2>
                <div class="container">
                        <div class="row">

                            <div class="col">
                                <div id="carrosProntosColuna" class="card card-body">

                                </div>
                            </div>
                        </div>
                    </div>

                <div class="line"></div>

                <h3>Veículos por Atribuir</h3>
                <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
        </div>

        <!-- Modal Adicionar Funcionarios -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Aprovar Orçamento</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="form1" method="post">
                            <div class="form-group">
                                <label for="exampleInputEmail1">Email Cliente</label>
                                <input type="text" id="email" name="email" class="form-control" id="acaoInput"
                        aria-describedby="emailHelp" placeholder="Escreva aqui..." required>
                            </div>
                            
                            <div class="form-group">
                                <label for="exampleInputEmail1">Matrícula Veículo</label>
                                <input type="text" class="form-control" name="matricula" id="matricula" aria-describedby="emailHelp"
                                placeholder="Escreva aqui..." required>
                            </div>
                            <div class="form-group" hidden>
                                <label for="exampleInputEmail1">nomeAdmin</label>
                                <input type="text" class="form-control" name="nomeAdmin" id="nomeAdmin" aria-describedby="emailHelp"
                                placeholder="Escreva aqui..." hidden>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="dismissalButton" class="btn btn-warning" data-dismiss="modal">Close</button>
                        <button id="botaoAprovarOrcamento" type="submit" form="form1" class="btn btn-primary">Aprovar</button>
                    </div>
                </div>
            </div>
        </div>

        {{!-- Receive data for later --}}
        <p id="matriculasEspera" hidden>{{matriculasEspera}}</p>
        <p id="matriculasTrabalho" hidden>{{matriculasTrabalho}}</p>
        <p id="matriculasProntas" hidden>{{matriculasProntas}}</p>

        <!-- jQuery CDN - Slim version (=without AJAX) -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <!-- Popper.JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <!-- Bootstrap JS -->
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

    </body>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                $(this).toggleClass('active');
            });
        });

        //-------------------------------------------------------------------
        //Lista Carros
        //-------------------------------------------------------------------

        // Em espera
        let matriculasEsperaString = document.getElementById("matriculasEspera").innerHTML
        let arrayMatriculasEspera = matriculasEsperaString.split(',')

        // Reparacao
        let matriculasTrabalhoString = document.getElementById("matriculasTrabalho").innerHTML
        let arrayMatriculasReparacao = matriculasTrabalhoString.split(',')

        // Prontos
        let matriculasProntasString = document.getElementById("matriculasProntas").innerHTML
        let arrayMatriculasProntas = matriculasProntasString.split(',')

        // Colunas
        let carrosEspera = document.getElementById("carrosEsperaColuna")
        let carrosTrabalho = document.getElementById("carrosReparacaoColuna")
        let carrosProntos = document.getElementById("carrosProntosColuna")

        let jsonData;
        let jsonData2;

        // Fetch das tarefas pertencentes aos veiculos em espera, funçoes para mostrar listas dos veículos
        fetch('http://localhost:3000/getAllTarefas').then(
            async (result) => {
                jsonData = await result.json();
                console.log("jsonData", jsonData)
                console.log('this: ', jsonData.tarefasVeiculosEspera.length)

                //Create Espera view
                if (jsonData.tarefasVeiculosEspera.length > 0) {
                    for (i = 0; i < arrayMatriculasEspera.length; i++) {
                        //Create paragrafo de cada veiculo
                        let linha = document.createElement('p')
                        linha.setAttribute('id', 'veiculo' + [i + 1])
                        linha.setAttribute('style', "display:-webkit-inline-box;")
                        linha.innerHTML = arrayMatriculasEspera[i]

                        // Criar botao view
                        temp = document.createElement('button')
                        temp.setAttribute("id", "botaoEspera" + [i + 1])
                        temp.setAttribute("class", "btn btn-primary")
                        temp.setAttribute("data-toggle", "collapse")
                        temp.setAttribute("aria-expanded", "false")
                        temp.setAttribute("data-target", "#detalhesEspera" + [i + 1])
                        temp.setAttribute("aria-controls", "detalhesEspera" + [i + 1])
                        temp.setAttribute("style", "margin-right: 5px; margin-left: 5px;")
                        temp.innerHTML = "View"

                        //Appends
                        linha.appendChild(temp)
                        carrosEspera.appendChild(linha)

                        // Criar primeiro div
                        firstDiv = document.createElement('div')
                        firstDiv.setAttribute("class", "collapse multi-collapse")
                        firstDiv.setAttribute("id", "detalhesEspera" + [i + 1])

                        // Criar segundo div
                        secondDiv = document.createElement('div')
                        secondDiv.setAttribute("class", "card card-body")
                        secondDiv.setAttribute("id", "divEspera" + [i + 1])
                        secondDiv.setAttribute("style", "white-space: pre-wrap;")

                        //Appends
                        firstDiv.appendChild(secondDiv)
                        carrosEspera.appendChild(firstDiv)
                    }

                    //Inserts the descriçoes after view button is pressed
                    for (i = 0; i < jsonData.tarefasVeiculosEspera.length; i++) {
                        let text = "";
                        for (j = 0; j < jsonData.tarefasVeiculosEspera[i].length; j++) {
                            if (text != "") {
                            text = text + "\n-" + jsonData.tarefasVeiculosEspera[i][j].descricao
                            }
                            else {
                            text = text + jsonData.tarefasVeiculosEspera[i][j].descricao
                            }
                        }
                        if (document.getElementById("divEspera" + [i + 1]).id === "divEspera" + [i + 1]) {
                            document.getElementById("divEspera" + [i + 1]).innerHTML = "-" + text
                        }
                        text = ""
                    }
                } else {
                    linha = document.createElement('p')
                    linha.setAttribute('id', 'veiculo' + [i + 1])
                    linha.setAttribute('style', "display:-webkit-inline-box;")
                    linha.innerHTML = 'Não existem viaturas em espera'
                    carrosEspera.appendChild(linha)
                }

                //Create Reparação view
                if (jsonData.tarefasVeiculosReparacao.length > 0) {
                    for (i = 0; i < arrayMatriculasReparacao.length; i++) {
                        //Create paragrafo de cada veiculo
                        let linha = document.createElement('p')
                        linha.setAttribute('id', 'veiculo' + [i + 1])
                        linha.setAttribute('style', "display:-webkit-inline-box;")
                        linha.innerHTML = arrayMatriculasReparacao[i]

                        // Criar botao view
                        temp = document.createElement('button')
                        temp.setAttribute("id", "botaoEspera" + [i + 1])
                        temp.setAttribute("class", "btn btn-primary")
                        temp.setAttribute("data-toggle", "collapse")
                        temp.setAttribute("aria-expanded", "false")
                        temp.setAttribute("data-target", "#detalhesTrabalho" + [i + 1])
                        temp.setAttribute("aria-controls", "detalhesTrabalho" + [i + 1])
                        temp.setAttribute("style", "margin-right: 5px; margin-left: 5px;")
                        temp.innerHTML = "View"

                        //Appends
                        linha.appendChild(temp)
                        carrosTrabalho.appendChild(linha)

                        // Criar primeiro div
                        firstDiv = document.createElement('div')
                        firstDiv.setAttribute("class", "collapse multi-collapse")
                        firstDiv.setAttribute("id", "detalhesTrabalho" + [i + 1])

                        // Criar segundo div
                        secondDiv = document.createElement('div')
                        secondDiv.setAttribute("class", "card card-body")
                        secondDiv.setAttribute("id", "divTrabalho" + [i + 1])
                        secondDiv.setAttribute("style", "white-space: pre-wrap;")

                        //Appends
                        firstDiv.appendChild(secondDiv)
                        carrosTrabalho.appendChild(firstDiv)
                    }

                    //Inserts the descriçoes after view button is pressed
                    for (i = 0; i < jsonData.tarefasVeiculosReparacao.length; i++) {
                    let text = "";
                    for (j = 0; j < jsonData.tarefasVeiculosReparacao[i].length; j++) {
                        if (text != "") {
                        text = text + "\n-" + jsonData.tarefasVeiculosReparacao[i][j].descricao
                        }
                        else {
                        text = text + jsonData.tarefasVeiculosReparacao[i][j].descricao
                        }
                    }
                    if (document.getElementById("divTrabalho" + [i + 1]).id === "divTrabalho" + [i + 1]) {
                        document.getElementById("divTrabalho" + [i + 1]).innerHTML = "-" + text
                    }
                    text = ""
                    }
                } else {
                    linha = document.createElement('p')
                    linha.setAttribute('id', 'veiculo' + [i + 1])
                    linha.setAttribute('style', "display:-webkit-inline-box;")
                    linha.innerHTML = 'Não existem viaturas em reparação'
                    carrosTrabalho.appendChild(linha)
                }

                //Create Prontos view
                if (jsonData.tarefasVeiculosProntos.length > 0) {
                    for (i = 0; i < arrayMatriculasProntas.length; i++) {
                        //Create paragrafo de cada veiculo
                        let linha = document.createElement('p')
                        linha.setAttribute('id', 'veiculo' + [i + 1])
                        linha.setAttribute('style', "display:-webkit-inline-box;")
                        linha.innerHTML = arrayMatriculasProntas[i]

                        // Criar botao view
                        temp = document.createElement('button')
                        temp.setAttribute("id", "botaoEspera" + [i + 1])
                        temp.setAttribute("class", "btn btn-primary")
                        temp.setAttribute("data-toggle", "collapse")
                        temp.setAttribute("aria-expanded", "false")
                        temp.setAttribute("data-target", "#detalhesPronto" + [i + 1])
                        temp.setAttribute("aria-controls", "detalhesPronto" + [i + 1])
                        temp.setAttribute("style", "margin-right: 5px; margin-left: 5px;")
                        temp.innerHTML = "View"

                        //Appends
                        linha.appendChild(temp)
                        carrosProntos.appendChild(linha)

                        // Criar primeiro div
                        firstDiv = document.createElement('div')
                        firstDiv.setAttribute("class", "collapse multi-collapse")
                        firstDiv.setAttribute("id", "detalhesPronto" + [i + 1])

                        // Criar segundo div
                        secondDiv = document.createElement('div')
                        secondDiv.setAttribute("class", "card card-body")
                        secondDiv.setAttribute("id", "divPronto" + [i + 1])
                        secondDiv.setAttribute("style", "white-space: pre-wrap;")

                        //Appends
                        firstDiv.appendChild(secondDiv)
                        carrosProntos.appendChild(firstDiv)
                    }

                    //Inserts the descriçoes after view button is pressed
                    for (i = 0; i < jsonData.tarefasVeiculosProntos.length; i++) {
                    let text = "";
                    for (j = 0; j < jsonData.tarefasVeiculosProntos[i].length; j++) {
                        if (text != "") {
                        text = text + "\n-" + jsonData.tarefasVeiculosProntos[i][j].descricao
                        }
                        else {
                        text = text + jsonData.tarefasVeiculosProntos[i][j].descricao
                        }
                    }
                    if (document.getElementById("divPronto" + [i + 1]).id === "divPronto" + [i + 1]) {
                        document.getElementById("divPronto" + [i + 1]).innerHTML = "-" + text
                    }
                    text = ""
                    }
                } else {
                    linha = document.createElement('p')
                    linha.setAttribute('id', 'veiculo' + [i + 1])
                    linha.setAttribute('style', "display:-webkit-inline-box;")
                    linha.innerHTML = 'Não existem viaturas prontas'
                    carrosProntos.appendChild(linha)
                }
            }
        ).catch((e) => {
            console.log('Couldnt get data from server')
        })
        
        //Code when worker updates orcçamento
        document.getElementById('botaoAprovarOrcamento').addEventListener('click', (e) => {
            let formAprovarOrcamento = document.querySelector('#form1')
            //Get the worker name
            var url = window.location.href
            var nomeAdmin = url.replace('http://localhost:3000/responsavel/','');

            document.getElementById('nomeAdmin').value = nomeAdmin

            formAprovarOrcamento.setAttribute('action', 'http://localhost:3000/aprovarOrcamentos')
        })

    </script>

</html>